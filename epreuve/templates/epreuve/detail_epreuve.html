{% extends 'olympiadesnsi/base_participant.html' %}

{% block content %}
    <div class="container mt-4">
        <h1>{{ epreuve.nom }}</h1>

        <div class="mb-3">
            <strong>Date de d√©but :</strong> {{ epreuve.date_debut|date:"d M Y" }}<br>
            <strong>Date de fin :</strong> {{ epreuve.date_fin|date:"d M Y" }}
        </div>

        {% if epreuve.temps_limite %}
            <div class="alert alert-info">
                Cette √©preuve est √† dur√©e limit√©e.
                <strong>Dur√©e :</strong> {{ epreuve.duree }} minutes.
                Le chronom√®tre d√©marrera lorsque vous aurez cliqu√© sur "D√©marrer l'√©preuve".
            </div>
        {% else %}
            <div class="alert alert-success">
                Il n'y a pas de limite de temps pour cette √©preuve.
            </div>
        {% endif %}

        {% if epreuve.exercices_un_par_un %}
            <div class="alert alert-warning">
                Les exercices doivent √™tre trait√©s un par un.
            </div>
        {% else %}
            <div class="alert alert-secondary">
                Vous pouvez traiter les exercices dans l'ordre de votre choix.
            </div>
        {% endif %}

        {% if indication_utilisateurs_retour > 0 %}
            <div class="alert alert-info shadow-sm border rounded p-3">
                <p>
                    <strong>üîé Pour {{ indication_utilisateurs_retour }} exercice(s), vous avez un retour en
                        direct</strong>
                    sur la r√©ponse au jeu de test que vous enregistrez.
                </p>

                <ul class="list-unstyled">
                    <li>
                        <i class="indic-exo-valide fa-regular fa-circle-check fa-lg" style="color:green;"></i>
                        <strong> R√©ponse correcte avec code enregistr√© :</strong> votre r√©ponse au jeu de test est valide
                        et un code a bien √©t√© enregistr√©.
                        Pensez √† v√©rifier que le code soumis est bien celui qui a g√©n√©r√© la r√©ponse.

                    </li>
                    <li>
                        <i class="indic-exo-code-manquant fa-regular fa-pencil fa-lg" style="color:orange;"></i>
                        <strong> R√©ponse correcte mais code manquant :</strong> attention, votre r√©ponse est correcte
                        mais aucun code n‚Äôa √©t√© soumis.
                    </li>
                    <li>
                        <i class="indic-exo-invalide fa-regular fa-circle-xmark fa-lg" style="color:red;"></i>
                        <strong> R√©ponse incorrecte :</strong> votre code n‚Äôa pas produit la bonne r√©ponse.
                    </li>
                    <li>
                        <i class="indic-exo-non-soumis fa-regular fa-circle-question fa-lg" style="color:gray;"></i>
                        <strong> Exercice non soumis ou pas de v√©rification:</strong> Soit aucune r√©ponse n‚Äôa √©t√© enregistr√©e, soit aucune v√©rification n'est pr√©vue pour cet exercice.
                    </li>
                </ul>

                <p class="mt-3">
                    <i class="fa-solid fa-triangle-exclamation fa-lg text-warning"></i>
                    <strong> Attention :</strong> assurez-vous que le code soumis correspond bien √† la version ayant
                    g√©n√©r√© la r√©ponse valid√©e.
                </p>
            </div>
        {% endif %}

        {% if epreuve.doit_demander_identifiants %}
            <p>Merci de renseigner votre situation concernant l'√©preuve th√©orique :</p>

            <form method="POST">
                {% csrf_token %}
                {% for i in "123"|make_list %}
                    <div class="card mb-3 p-3" id="participant_card_{{ i }}">
                        <div class="form-group">
                            <label class="form-label"><strong>Participant {{ i }} :</strong></label>

                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="choix_{{ i }}" value="1"
                                       id="choix_{{ i }}_1"
                                       {% if anonymats|slice:forloop.counter0|first not in "X-?" %}checked{% endif %}
                                       onchange="toggleInput('{{ i }}'); cascadeDisable('{{ i }}', false);">
                                <label class="form-check-label" for="choix_{{ i }}_1">
                                    J'ai particip√© et j'ai mon num√©ro d'anonymat
                                </label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="choix_{{ i }}" value="2"
                                       id="choix_{{ i }}_2"
                                       {% if anonymats|slice:forloop.counter0|first == "?" %}checked{% endif %}
                                       onchange="toggleInput('{{ i }}'); cascadeDisable('{{ i }}', false);">
                                <label class="form-check-label" for="choix_{{ i }}_2">
                                    J'ai particip√© mais je n'ai pas mon num√©ro
                                </label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="choix_{{ i }}" value="3"
                                       id="choix_{{ i }}_3"
                                       {% if anonymats|slice:forloop.counter0|first == "-" %}checked{% endif %}
                                       onchange="toggleInput('{{ i }}'); cascadeDisable('{{ i }}', false);">
                                <label class="form-check-label" for="choix_{{ i }}_3">
                                    Je n'ai pas particip√©
                                </label>
                            </div>

                            {% if forloop.counter > 1 %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="choix_{{ i }}" value="4"
                                           id="choix_{{ i }}_4"
                                           {% if anonymats|slice:forloop.counter0|first == "X" %}checked{% endif %}
                                           onchange="toggleInput('{{ i }}'); cascadeDisable('{{ i }}', true);">
                                    <label class="form-check-label text-danger" for="choix_{{ i }}_4">
                                        L'√©quipe ne comporte pas autant de participants
                                    </label>
                                </div>
                            {% endif %}

                            <input type="text" class="form-control anonymat mt-2" id="anonymat_{{ i }}"
                                   name="anonymat_{{ i }}"
                                   value="
                                           {% if anonymats|slice:forloop.counter0|first not in 'X-?' %}{{ anonymats|slice:forloop.counter0|first }}{% endif %}"
                                   {% if anonymats|slice:forloop.counter0|first in 'X-?' %}style="display:none;"{% endif %}
                                   placeholder="Entrez votre num√©ro d'anonymat">
                        </div>
                    </div>
                {% endfor %}


                <button type="submit" class="btn btn-primary mt-3">Enregistrer</button>
            </form>
        {% else %}
            <a href="{% url 'afficher_epreuve' epreuve.hashid %}" class="btn btn-primary">D√©marrer l'√©preuve</a>
        {% endif %}

    </div>

    <script>
        function toggleInput(i) {
            const choix1 = document.getElementById(`choix_${i}_1`);
            const input = document.getElementById(`anonymat_${i}`);
            if (choix1.checked) {
                input.style.display = '';
            } else {
                input.style.display = 'none';
                input.value = '';
            }
        }

        function cascadeDisable(index, disableFollowing) {
            const start = parseInt(index, 10);
            const total = 3; // nombre total de participants

            for (let i = start + 1; i <= total; i++) {
                const inputs = document.getElementsByName(`choix_${i}`);
                const anonymat = document.getElementById(`anonymat_${i}`);

                if (disableFollowing) {
                    // Cocher automatiquement l'option "pas autant de participants"
                    const choix4 = document.getElementById(`choix_${i}_4`);
                    if (choix4) {
                        choix4.checked = true;
                    }
                    anonymat.style.display = 'none';
                    anonymat.value = '';
                }

                // Activer ou d√©sactiver toutes les options
                inputs.forEach(input => {
                    if (input.value !== "4") {
                        input.disabled = disableFollowing;
                    }
                });
            }
        }
    </script>


{% endblock %}
